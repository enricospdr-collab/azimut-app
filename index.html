<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Azimut Pro Tool Avanzato</title>

<link rel="manifest" href="manifest.json">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body { margin:0; font-family: Arial; }
#map { height:60vh; }
#panel {
  height:40vh;
  padding:10px;
  background:#f2f2f2;
  overflow:auto;
}
input, select, button { padding:4px; margin:2px; }
.result-item { padding:5px; cursor:pointer; border-bottom:1px solid #ccc; }
.result-item:hover { background:#ddd; }
.address-label { font-size:12px; background:white; padding:4px; border:1px solid black; }
</style>
</head>
<body>

<div id="map"></div>

<div id="panel">

<h3>Ricerca località</h3>
<input type="text" id="searchInput" placeholder="Es. Vicenza, Via Roma 10 Milano">
<select id="pointSelector">
  <option value="1">Imposta come Punto 1</option>
  <option value="2">Imposta come Punto 2</option>
</select>
<button onclick="goToMyLocation()">Vai alla mia posizione</button>
<div id="searchResults"></div>

<hr>

<input type="checkbox" id="lockPoints"> Blocca marker

Declinazione magnetica (°):
<input type="number" id="decl" value="0" step="0.1">

<br><br>
<button onclick="addSegmentManual()">Aggiungi segmento</button>
<button onclick="resetAll()">Reset completo</button>
<button onclick="exportCSV()">Esporta CSV</button>

<div id="results"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>

let map = L.map('map').setView([45.545, 11.535], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

let markers = [null,null];
let addresses = ["",""];
let multiLines = [];
let angleMarker;
let polyPoints = [];
let polyLine;

/* =============================
   AUTOCOMPLETE NOMINATIM
============================= */
let timeout = null;
document.getElementById("searchInput").addEventListener("input", function() {
  clearTimeout(timeout);
  let query = this.value;
  if(query.length < 3){ document.getElementById("searchResults").innerHTML=""; return; }
  timeout = setTimeout(()=> searchLocation(query), 500);
});

async function searchLocation(query){
  let url = "https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q=" + encodeURIComponent(query);
  let response = await fetch(url);
  let data = await response.json();
  let resultsDiv = document.getElementById("searchResults");
  resultsDiv.innerHTML="";
  data.slice(0,5).forEach(place=>{
    let div=document.createElement("div");
    div.className="result-item";
    div.innerText=place.display_name;
    div.onclick=()=>selectLocation(place);
    resultsDiv.appendChild(div);
  });
}

function selectLocation(place){
  let lat=parseFloat(place.lat);
  let lon=parseFloat(place.lon);
  let pointIndex=parseInt(document.getElementById("pointSelector").value)-1;
  setPoint(pointIndex, lat, lon, place.display_name);
  map.setView([lat,lon],15);
  document.getElementById("searchResults").innerHTML="";
}

/* =============================
   GEOLOCALIZZAZIONE
============================= */
function goToMyLocation(){
  if(!navigator.geolocation){ alert("Geolocalizzazione non supportata"); return; }
  navigator.geolocation.getCurrentPosition(position=>{
    let lat=position.coords.latitude;
    let lon=position.coords.longitude;
    let pointIndex=parseInt(document.getElementById("pointSelector").value)-1;
    setPoint(pointIndex, lat, lon, "Posizione GPS");
    map.setView([lat,lon],15);
  });
}

/* =============================
   CLICK SULLA MAPPA PER PUNTO
============================= */
map.on('click', function(e){
  let pointIndex = parseInt(document.getElementById("pointSelector").value)-1;
  setPoint(pointIndex, e.latlng.lat, e.latlng.lng, "Punto selezionato manualmente");
});

/* =============================
   FUNZIONI PUNTO
============================= */
function setPoint(index, lat, lon, address){
  if(markers[index]){
    map.removeLayer(markers[index]);
  }

  let draggable = !document.getElementById("lockPoints").checked;

  markers[index] = L.marker([lat, lon], { draggable: draggable }).addTo(map);
  addresses[index] = address;

  markers[index].bindPopup(address+"<br>Lat: "+lat.toFixed(6)+", Lon: "+lon.toFixed(6)).openPopup();

  if(draggable){
    markers[index].on('drag', function(e){
      let p = e.target.getLatLng();
      addresses[index] = "Punto spostato manualmente";
      markers[index].bindPopup(addresses[index]+"<br>Lat: "+p.lat.toFixed(6)+", Lon: "+p.lng.toFixed(6)).openPopup();
      updateLineAndCalculate();
    });
  }

  updateLineAndCalculate();
}

function updateLineAndCalculate(){
  multiLines.forEach(l=>map.removeLayer(l));
  multiLines = [];
  polyPoints = [];
  polyLine && map.removeLayer(polyLine);
  polyLine = null;

  if(markers[0] && markers[1]){
    let line = L.polyline([markers[0].getLatLng(), markers[1].getLatLng()], {color:'red'}).addTo(map);
    multiLines.push(line);
    calculateAll();
  }
}

/* =============================
   CALCOLI
============================= */
function calculateAll(){
  let lat1=markers[0].getLatLng().lat;
  let lon1=markers[0].getLatLng().lng;
  let lat2=markers[1].getLatLng().lat;
  let lon2=markers[1].getLatLng().lng;

  let az=calculateAzimuth(lat1,lon1,lat2,lon2);
  let dist=haversine(lat1,lon1,lat2,lon2);

  let decl=parseFloat(document.getElementById("decl").value);
  let azMag=(az-decl+360)%360;

  showAngleOnMap(az);

  document.getElementById("results").innerHTML=
    "<b>Punto 1:</b> "+addresses[0]+"<br>"+
    "<b>Punto 2:</b> "+addresses[1]+"<br><br>"+
    "<b>Azimut geografico:</b> "+az.toFixed(2)+"°<br>"+
    "<b>Azimut magnetico:</b> "+azMag.toFixed(2)+"°<br>"+
    "<b>Distanza:</b> "+dist.toFixed(2)+" m";
}

function calculateAzimuth(lat1,lon1,lat2,lon2){
  lat1=toRad(lat1); lon1=toRad(lon1);
  lat2=toRad(lat2); lon2=toRad(lon2);

  let dLon=lon2-lon1;
  let y=Math.sin(dLon)*Math.cos(lat2);
  let x=Math.cos(lat1)*Math.sin(lat2)-Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon);

  let brng=Math.atan2(y,x);
  brng=toDeg(brng);
  return (brng+360)%360;
}

function haversine(lat1,lon1,lat2,lon2){
  const R=6371000;
  let dLat=toRad(lat2-lat1);
  let dLon=toRad(lon2-lon1);
  lat1=toRad(lat1); lat2=toRad(lat2);
  let a=Math.sin(dLat/2)**2+Math.sin(dLon/2)**2*Math.cos(lat1)*Math.cos(lat2);
  let c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*c;
}

function showAngleOnMap(az){
  if(angleMarker) map.removeLayer(angleMarker);
  let p=markers[0].getLatLng();
  angleMarker=L.marker(p,{
    icon:L.divIcon({ className:'address-label', html:az.toFixed(1)+'°' })
  }).addTo(map);
}

/* =============================
   POLIGONO E SEGMENTI MULTIPLI
============================= */
function addSegmentManual(){
  if(markers[0] && markers[1]){
    let lat1=markers[0].getLatLng().lat;
    let lon1=markers[0].getLatLng().lng;
    let lat2=markers[1].getLatLng().lat;
    let lon2=markers[1].getLatLng().lng;

    let line = L.polyline([[lat1,lon1],[lat2,lon2]], {color:'blue'}).addTo(map);
    multiLines.push(line);
    polyPoints.push([lat1,lon1],[lat2,lon2]);
  }
}

/* =============================
   RESET & EXPORT
============================= */
function resetAll(){
  markers.forEach(m=>m && map.removeLayer(m));
  multiLines.forEach(l=>map.removeLayer(l));
  polyLine && map.removeLayer(polyLine);
  angleMarker && map.removeLayer(angleMarker);
  markers=[null,null];
  addresses=["",""];
  multiLines=[];
  polyPoints=[];
  polyLine=null;
  document.getElementById("results").innerHTML="";
}

function exportCSV(){
  if(!markers[0] || !markers[1]) return;
  let lat1=markers[0].getLatLng().lat;
  let lon1=markers[0].getLatLng().lng;
  let lat2=markers[1].getLatLng().lat;
  let lon2=markers[1].getLatLng().lng;
  let az=calculateAzimuth(lat1,lon1,lat2,lon2);
  let dist=haversine(lat1,lon1,lat2,lon2);

  let csv="Punto1,Punto2,Lat1,Lon1,Lat2,Lon2,Azimut,Distanza_m\n"+
          addresses[0]+","+addresses[1]+","+
          lat1+","+lon1+","+lat2+","+lon2+","+az+","+dist;

  let blob=new Blob([csv],{type:"text/csv"});
  let url=URL.createObjectURL(blob);
  let a=document.createElement("a");
  a.href=url;
  a.download="azimut_data.csv";
  a.click();
}

function toRad(v){ return v*Math.PI/180; }
function toDeg(v){ return v*180/Math.PI; }

if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js'); }

</script>
</body>
</html>