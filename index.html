<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Azimut Multi-Point Tool</title>

<link rel="manifest" href="manifest.json">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body { margin:0; font-family: Arial; }
#map { height:60vh; }
#panel { height:40vh; padding:10px; background:#f2f2f2; overflow:auto; }
input, select, button { padding:4px; margin:2px; }
.result-item { padding:5px; cursor:pointer; border-bottom:1px solid #ccc; }
.result-item:hover { background:#ddd; }
.address-label { font-size:12px; background:white; padding:4px; border:1px solid black; }
</style>
</head>
<body>

<div id="map"></div>

<div id="panel">

<h3>Ricerca località</h3>
<input type="text" id="searchInput" placeholder="Es. Vicenza, Via Roma 10 Milano">
<button onclick="goToMyLocation()">Vai alla mia posizione</button>
<div id="searchResults"></div>

<hr>

<input type="checkbox" id="lockPoints"> Blocca marker

Declinazione magnetica (°):
<input type="number" id="decl" value="0" step="0.1">

<br><br>
<button onclick="resetAll()">Reset completo</button>
<button onclick="exportCSV()">Esporta CSV</button>

<div id="results"></div>
</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>

let map = L.map('map').setView([45.545, 11.535], 13);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '&copy; OpenStreetMap contributors' }).addTo(map);

let markers = [];  // fino a 20 punti
let addresses = [];
let multiLines = [];
let angleMarkers = [];

/* =============================
   AUTOCOMPLETE NOMINATIM
============================= */
let timeout = null;
document.getElementById("searchInput").addEventListener("input", function() {
  clearTimeout(timeout);
  let query = this.value;
  if(query.length < 3){ document.getElementById("searchResults").innerHTML=""; return; }
  timeout = setTimeout(()=> searchLocation(query), 500);
});

async function searchLocation(query){
  let url = "https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&q=" + encodeURIComponent(query);
  let response = await fetch(url);
  let data = await response.json();
  let resultsDiv = document.getElementById("searchResults");
  resultsDiv.innerHTML="";
  data.slice(0,5).forEach(place=>{
    let div=document.createElement("div");
    div.className="result-item";
    div.innerText=place.display_name;
    div.onclick=()=>selectLocation(place);
    resultsDiv.appendChild(div);
  });
}

function selectLocation(place){
  addPoint(parseFloat(place.lat), parseFloat(place.lon), place.display_name);
  map.setView([place.lat, place.lon],15);
  document.getElementById("searchResults").innerHTML="";
}

/* =============================
   GEOLOCALIZZAZIONE
============================= */
function goToMyLocation(){
  if(!navigator.geolocation){ alert("Geolocalizzazione non supportata"); return; }
  navigator.geolocation.getCurrentPosition(position=>{
    addPoint(position.coords.latitude, position.coords.longitude, "Posizione GPS");
    map.setView([position.coords.latitude, position.coords.longitude],15);
  });
}

/* =============================
   CLICK SULLA MAPPA
============================= */
map.on('click', function(e){
  addPoint(e.latlng.lat, e.latlng.lng, "Punto selezionato manualmente");
});

/* =============================
   AGGIUNTA PUNTO (fino a 20)
============================= */
function addPoint(lat, lon, address){
  if(markers.length >= 20){ alert("Limite massimo 20 punti raggiunto"); return; }

  let draggable = !document.getElementById("lockPoints").checked;

  let marker = L.marker([lat, lon], { draggable: draggable }).addTo(map);
  marker.bindPopup(address+"<br>Lat: "+lat.toFixed(6)+", Lon: "+lon.toFixed(6)).openPopup();

  if(draggable){
    marker.on('drag', function(e){
      let p = e.target.getLatLng();
      addresses[markers.indexOf(marker)] = "Punto spostato manualmente";
      marker.bindPopup(addresses[markers.indexOf(marker)]+"<br>Lat: "+p.lat.toFixed(6)+", Lon: "+p.lng.toFixed(6)).openPopup();
      updateLinesAndCalculate();
    });
  }

  markers.push(marker);
  addresses.push(address);

  updateLinesAndCalculate();
}

/* =============================
   LINEE E CALCOLI
============================= */
function updateLinesAndCalculate(){
  multiLines.forEach(l=>map.removeLayer(l));
  multiLines = [];
  angleMarkers.forEach(a=>map.removeLayer(a));
  angleMarkers = [];

  let decl=parseFloat(document.getElementById("decl").value);
  let resultsHTML="";

  for(let i=0; i<markers.length-1; i++){
    let lat1=markers[i].getLatLng().lat;
    let lon1=markers[i].getLatLng().lng;
    let lat2=markers[i+1].getLatLng().lat;
    let lon2=markers[i+1].getLatLng().lng;

    let az=calculateAzimuth(lat1,lon1,lat2,lon2);
    let azMag=(az-decl+360)%360;
    let dist=haversine(lat1,lon1,lat2,lon2);

    let line=L.polyline([[lat1,lon1],[lat2,lon2]], {color:'red'}).addTo(map);
    multiLines.push(line);

    let angleMarker=L.marker(markers[i].getLatLng(), {
      icon:L.divIcon({className:'address-label', html:az.toFixed(1)+'°'})
    }).addTo(map);
    angleMarkers.push(angleMarker);

    resultsHTML+="<b>Segmento "+(i+1)+":</b> "+addresses[i]+" → "+addresses[i+1]+"<br>";
    resultsHTML+="Azimut geografico: "+az.toFixed(2)+"° | Azimut magnetico: "+azMag.toFixed(2)+"° | Distanza: "+dist.toFixed(2)+" m<br><br>";
  }

  document.getElementById("results").innerHTML = resultsHTML;
}

/* =============================
   FUNZIONI AZIMUT / DISTANZA
============================= */
function calculateAzimuth(lat1,lon1,lat2,lon2){
  lat1=toRad(lat1); lon1=toRad(lon1);
  lat2=toRad(lat2); lon2=toRad(lon2);
  let dLon=lon2-lon1;
  let y=Math.sin(dLon)*Math.cos(lat2);
  let x=Math.cos(lat1)*Math.sin(lat2)-Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon);
  let brng=Math.atan2(y,x);
  brng=toDeg(brng);
  return (brng+360)%360;
}

function haversine(lat1,lon1,lat2,lon2){
  const R=6371000;
  let dLat=toRad(lat2-lat1);
  let dLon=toRad(lon2-lon1);
  lat1=toRad(lat1); lat2=toRad(lat2);
  let a=Math.sin(dLat/2)**2+Math.sin(dLon/2)**2*Math.cos(lat1)*Math.cos(lat2);
  let c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
  return R*c;
}

function toRad(v){ return v*Math.PI/180; }
function toDeg(v){ return v*180/Math.PI; }

/* =============================
   RESET & EXPORT
============================= */
function resetAll(){
  markers.forEach(m=>m && map.removeLayer(m));
  multiLines.forEach(l=>map.removeLayer(l));
  angleMarkers.forEach(a=>map.removeLayer(a));
  markers=[]; addresses=[]; multiLines=[]; angleMarkers=[];
  document.getElementById("results").innerHTML="";
}

function exportCSV(){
  if(markers.length < 2) return;
  let csv="Segmento,Punto1,Punto2,Lat1,Lon1,Lat2,Lon2,Azimut,Azimut_magnetico,Distanza_m\n";
  let decl=parseFloat(document.getElementById("decl").value);
  for(let i=0;i<markers.length-1;i++){
    let lat1=markers[i].getLatLng().lat;
    let lon1=markers[i].getLatLng().lng;
    let lat2=markers[i+1].getLatLng().lat;
    let lon2=markers[i+1].getLatLng().lng;
    let az=calculateAzimuth(lat1,lon1,lat2,lon2);
    let azMag=(az-decl+360)%360;
    let dist=haversine(lat1,lon1,lat2,lon2);
    csv+=(i+1)+","+addresses[i]+","+addresses[i+1]+","+lat1+","+lon1+","+lat2+","+lon2+","+az+","+azMag+","+dist+"\n";
  }
  let blob=new Blob([csv],{type:"text/csv"});
  let url=URL.createObjectURL(blob);
  let a=document.createElement("a");
  a.href=url; a.download="azimut_multi_segment.csv"; a.click();
}

/* =============================
   SERVICE WORKER
============================= */
if('serviceWorker' in navigator){ navigator.serviceWorker.register('service-worker.js'); }

</script>

</body>
</html>