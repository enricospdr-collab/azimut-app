<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Azimut Pro Tool</title>

<link rel="manifest" href="manifest.json">
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

<style>
body { margin:0; font-family: Arial; }
#map { height:70vh; }
#panel {
  height:30vh;
  padding:10px;
  background:#f2f2f2;
  overflow:auto;
}
input { width:120px; }
button { margin:4px; }
</style>
</head>
<body>

<div id="map"></div>

<div id="panel">

<h3>Azimut Pro Tool</h3>

Declinazione magnetica (째):
<input type="number" id="decl" value="0" step="0.1">

<br><br>

Lat1 <input id="lat1">
Lon1 <input id="lon1">
Lat2 <input id="lat2">
Lon2 <input id="lon2">
<button onclick="setManualPoints()">Imposta manualmente</button>

<br><br>

<button onclick="exportCSV()">Esporta CSV</button>
<button onclick="resetAll()">Reset</button>

<div id="results"></div>

</div>

<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

<script>

let map = L.map('map').setView([45.545, 11.535], 13);

L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
 attribution: '&copy; OpenStreetMap contributors'
}).addTo(map);

let markers = [];
let line;
let angleMarker;

map.on('click', function(e){
 if(markers.length===2) resetAll();
 addPoint(e.latlng.lat, e.latlng.lng);
});

function addPoint(lat,lng){
 let marker = L.marker([lat,lng]).addTo(map);
 markers.push(marker);
 if(markers.length===2){
   drawLine();
   calculateAll();
 }
}

function drawLine(){
 line = L.polyline([
   markers[0].getLatLng(),
   markers[1].getLatLng()
 ],{color:'red'}).addTo(map);
}

function calculateAll(){

 let lat1 = markers[0].getLatLng().lat;
 let lon1 = markers[0].getLatLng().lng;
 let lat2 = markers[1].getLatLng().lat;
 let lon2 = markers[1].getLatLng().lng;

 document.getElementById("lat1").value=lat1;
 document.getElementById("lon1").value=lon1;
 document.getElementById("lat2").value=lat2;
 document.getElementById("lon2").value=lon2;

 let az = calculateAzimuth(lat1,lon1,lat2,lon2);
 let dist = haversine(lat1,lon1,lat2,lon2);

 let decl = parseFloat(document.getElementById("decl").value);
 let azMag = (az - decl + 360)%360;

 showAngleOnMap(az);

 document.getElementById("results").innerHTML=
   "<b>Azimut geografico:</b> "+az.toFixed(2)+"째<br>"+
   "<b>Azimut magnetico:</b> "+azMag.toFixed(2)+"째<br>"+
   "<b>Distanza:</b> "+dist.toFixed(2)+" m";
}

function calculateAzimuth(lat1,lon1,lat2,lon2){

 lat1=toRad(lat1); lon1=toRad(lon1);
 lat2=toRad(lat2); lon2=toRad(lon2);

 let dLon=lon2-lon1;

 let y=Math.sin(dLon)*Math.cos(lat2);
 let x=Math.cos(lat1)*Math.sin(lat2)-
       Math.sin(lat1)*Math.cos(lat2)*Math.cos(dLon);

 let brng=Math.atan2(y,x);
 brng=toDeg(brng);
 return (brng+360)%360;
}

function haversine(lat1,lon1,lat2,lon2){
 const R=6371000;
 let dLat=toRad(lat2-lat1);
 let dLon=toRad(lon2-lon1);
 lat1=toRad(lat1);
 lat2=toRad(lat2);

 let a=Math.sin(dLat/2)**2+
       Math.sin(dLon/2)**2*Math.cos(lat1)*Math.cos(lat2);
 let c=2*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
 return R*c;
}

function showAngleOnMap(az){
 if(angleMarker) map.removeLayer(angleMarker);

 let p=markers[0].getLatLng();
 angleMarker=L.marker(p,{
   icon:L.divIcon({
     className:'angle-label',
     html:'<div style="background:white;padding:4px;border:1px solid black;">'+az.toFixed(1)+'째</div>'
   })
 }).addTo(map);
}

function setManualPoints(){
 resetAll();
 let lat1=parseFloat(lat1.value);
 let lon1=parseFloat(lon1.value);
 let lat2=parseFloat(lat2.value);
 let lon2=parseFloat(lon2.value);
 addPoint(lat1,lon1);
 addPoint(lat2,lon2);
}

function exportCSV(){
 if(markers.length<2) return;
 let lat1=markers[0].getLatLng().lat;
 let lon1=markers[0].getLatLng().lng;
 let lat2=markers[1].getLatLng().lat;
 let lon2=markers[1].getLatLng().lng;

 let az=calculateAzimuth(lat1,lon1,lat2,lon2);
 let dist=haversine(lat1,lon1,lat2,lon2);

 let csv="Lat1,Lon1,Lat2,Lon2,Azimut,Distanza_m\n"+
         lat1+","+lon1+","+lat2+","+lon2+","+az+","+dist;

 let blob=new Blob([csv],{type:"text/csv"});
 let url=URL.createObjectURL(blob);
 let a=document.createElement("a");
 a.href=url;
 a.download="azimut_data.csv";
 a.click();
}

function resetAll(){
 markers.forEach(m=>map.removeLayer(m));
 if(line) map.removeLayer(line);
 if(angleMarker) map.removeLayer(angleMarker);
 markers=[];
 document.getElementById("results").innerHTML="";
}

function toRad(v){ return v*Math.PI/180; }
function toDeg(v){ return v*180/Math.PI; }

if('serviceWorker' in navigator){
 navigator.serviceWorker.register('service-worker.js');
}

</script>

</body>
</html>